# OpenAI API Key for AI-powered step interpretation
OPENAI_API_KEY=your_openai_api_key_here

# Jira Configuration (optional)
JIRA_BASE_URL=https://your-domain.atlassian.net
JIRA_EMAIL=your-email@example.com
JIRA_API_TOKEN=your_jira_api_token_here

# Server Configuration
PORT=3001

___&____

You are a senior browser automation engineer with 20+ years of real-world experience.

You specialize in:
- Playwright, Selenium, Puppeteer
- AI-driven browser automation (browser-use, LLM agents)
- Login automation, SSO, OAuth, CAPTCHA handling
- Secure credential handling (env vars, vaults, token reuse)
- Handling dynamic DOM, XPath/CSS breakage
- Proxy issues (407), headless vs non-headless debugging
- Performance, stability, and production-ready automation

Rules you MUST follow:
1. Always give practical, production-ready answers.
2. Prefer step-by-step explanations over theory.
3. If code is required:
   - Show minimal but complete working code
   - Explain WHY each step exists
4. Point out common mistakes and how to avoid them.
5. If multiple approaches exist:
   - Compare them
   - Recommend the BEST one for real projects
6. Assume the user is a developer working under time pressure.
7. Avoid generic AI answers. Think like a real engineer debugging a real issue.
8. Ask clarifying questions ONLY if absolutely required.

Your goal:
Help me build reliable, secure, and maintainable browser automation solutions efficiently.

_____&______

import os
import asyncio
from typing import Optional, List

from dotenv import load_dotenv

# -------------------------------------------------
# ENV must be loaded FIRST (telemetry, security)
# -------------------------------------------------
load_dotenv()

from browser_use import Agent, Browser
from browser_use.llm import ChatOpenAI

from oauth import get_oauth_token


class BrowserUseService:
    """
    Browser-use compliant backend service.
    Designed for secured, local, multi-user usage.
    """

    def __init__(self):
        # LLM config
        self.base_url = os.getenv("OPENAI_BASE_URL")
        self.model = os.getenv("OPENAI_MODEL", "gpt-4o-mini")

        # Browser config
        self.headless = os.getenv("BROWSER_HEADLESS", "true").lower() == "true"

        # Security
        self.allowed_domains = self._load_allowed_domains()

        # Concurrency control
        max_agents = int(os.getenv("MAX_CONCURRENT_AGENTS", "20"))
        self._semaphore = asyncio.Semaphore(max_agents)

        # Browser singleton
        self._browser: Optional[Browser] = None

    # -------------------------------------------------
    # Internal helpers
    # -------------------------------------------------
    def _load_allowed_domains(self) -> List[str]:
        raw = os.getenv("ALLOWED_DOMAINS", "")
        return [d.strip() for d in raw.split(",") if d.strip()]

    def _get_browser(self) -> Browser:
        if self._browser is None:
            # telemetry already disabled via ENV
            self._browser = Browser(headless=self.headless)
        return self._browser

    def _get_llm(self) -> ChatOpenAI:
        token = get_oauth_token()
        return ChatOpenAI(
            api_key=token,
            base_url=self.base_url,
            model=self.model,
        )

    # -------------------------------------------------
    # Public API
    # -------------------------------------------------
    async def run_task(self, task: str) -> dict:
        """
        Execute a browser-use task.
        Task must describe navigation explicitly.
        """

        async with self._semaphore:
            agent = Agent(
                task=task,
                llm=self._get_llm(),
                browser=self._get_browser(),
                allowed_domains=self.allowed_domains,
            )

            history = await agent.run()

            return {
                "status": "success",
                "history": history,
            }

    # -------------------------------------------------
    # Shutdown hook (FastAPI lifespan)
    # -------------------------------------------------
    async def shutdown(self):
        if self._browser:
            await self._browser.close()
            self._browser = None


import os
import asyncio
from typing import Dict, Optional, List

from dotenv import load_dotenv

# -------------------------------------------------
# ENV must be loaded FIRST (telemetry + security)
# -------------------------------------------------
load_dotenv()

from browser_use import Agent, Browser, BrowserProfile
from browser_use.llm import ChatAzureOpenAI


class BrowserUseService:
    """
    Secure, browser-use compliant service.
    Safe for parallel FastAPI usage.
    """

    def __init__(self):
        # -------------------------
        # Concurrency control
        # -------------------------
        max_agents = int(os.getenv("MAX_CONCURRENT_AGENTS", "20"))
        self._semaphore = asyncio.Semaphore(max_agents)

        # -------------------------
        # LLM (can be reused)
        # -------------------------
        self.llm = ChatAzureOpenAI(
            model="gpt-4.1-mini",
            api_key=os.getenv("AZURE_OPENAI_KEY"),
            azure_endpoint=os.getenv("AZURE_OPENAI_ENDPOINT"),
        )

        # -------------------------
        # Browser profile (IMMUTABLE)
        # -------------------------
        self.browser_profile = BrowserProfile(
            allowed_domains=self._load_allowed_domains(),
            enable_default_extensions=False,
        )

        # -------------------------
        # Browser (shared)
        # -------------------------
        self.browser = Browser(
            browser_profile=self.browser_profile,
            headless=os.getenv("BROWSER_HEADLESS", "true").lower() == "true",
        )

    # -------------------------------------------------
    # Helpers
    # -------------------------------------------------
    def _load_allowed_domains(self) -> List[str]:
        raw = os.getenv("ALLOWED_DOMAINS", "")
        return [d.strip() for d in raw.split(",") if d.strip()]

    # -------------------------------------------------
    # Public API (THIS IS THE BACKBONE)
    # -------------------------------------------------
    async def run_task(
        self,
        task: str,
        sensitive_data: Optional[Dict[str, str]] = None,
        max_steps: int = 10,
    ) -> Dict:
        """
        Run a secure browser-use task.
        - New Agent per request
        - Shared browser + profile
        - Safe for parallel users
        """

        async with self._semaphore:
            agent = Agent(
                task=task,
                llm=self.llm,
                browser=self.browser,
                browser_profile=self.browser_profile,
                sensitive_data=sensitive_data or {},
            )

            history = await agent.run(max_steps=max_steps)

            return {
                "status": "success",
                "history": history,
            }

    # -------------------------------------------------
    # Shutdown hook (FastAPI lifespan later)
    # -------------------------------------------------
    async def shutdown(self):
        await self.browser.close()
