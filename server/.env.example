# OpenAI API Key for AI-powered step interpretation
OPENAI_API_KEY=your_openai_api_key_here

# Jira Configuration (optional)
JIRA_BASE_URL=https://your-domain.atlassian.net
JIRA_EMAIL=your-email@example.com
JIRA_API_TOKEN=your_jira_api_token_here

# Server Configuration
PORT=3001
import json

def interpret(test_text: str, llm):
    prompt = f"""
Convert the following UI test steps into JSON.

Rules:
- Allowed actions: open, fill, click, assert
- Do NOT add locators
- Return ONLY valid JSON array

Test steps:
{test_text}
"""
    return json.loads(llm.invoke(prompt))

____&_____
def resolve(page, meaning: str, llm):
    dom = page.content()

    prompt = f"""
You are a Playwright selector generator.

STRICT RULES:
- NEVER use XPath
- Use ONLY:
  - page.getByRole
  - page.getByLabel
  - page.getByPlaceholder
  - page.getByText
- Return ONLY valid Playwright Python code
- No explanation

Element meaning: {meaning}

DOM:
{dom}
"""
    return llm.invoke(prompt)

______&______
def heal(page, meaning: str, llm):
    dom = page.content()

    prompt = f"""
The previous selector failed.

Rules:
- NEVER use XPath
- Use Playwright semantic selectors only
- Return ONLY Playwright code

Element meaning: {meaning}

DOM:
{dom}
"""
    return llm.invoke(prompt)


______&____

def validate_selector(code: str):
    if not code.startswith("page."):
        raise ValueError("Invalid selector returned by AI")

    if "xpath" in code.lower():
        raise ValueError("XPath usage is forbidden")

    return True

____&___

from engine.validator import validate_selector
from agents.healing_agent import heal

def safe_exec(page, selector_code: str):
    validate_selector(selector_code)
    return eval(selector_code)

def execute(page, steps, locator_agent, llm):
    for step in steps:
        try:
            if step["action"] == "open":
                # page already opened in runner
                continue

            elif step["action"] == "fill":
                selector = locator_agent.resolve(page, step["field"], llm)
                safe_exec(page, selector).fill(step["value"])

            elif step["action"] == "click":
                selector = locator_agent.resolve(page, step["target"], llm)
                safe_exec(page, selector).click()

            elif step["action"] == "assert":
                selector = locator_agent.resolve(page, step["target"], llm)
                assert safe_exec(page, selector).is_visible()

        except Exception:
            healed_selector = heal(
                page,
                step.get("field") or step.get("target"),
                llm
            )
            safe_exec(page, healed_selector).click()


______&_____

import yaml
from playwright.sync_api import sync_playwright
from llm.llm_client import LLMClient
from agents.interpreter_agent import interpret
from agents.locator_agent import resolve
from engine.executor import execute

# Load config
with open("config/config.yaml") as f:
    config = yaml.safe_load(f)

# Load test case
with open("tests/test_cases/login.txt") as f:
    test_text = f.read()

# Init AI client (org north)
llm = LLMClient(config["llm"]["model"])

# Convert test → steps
steps = interpret(test_text, llm)

# Run Playwright
with sync_playwright() as p:
    browser = p.chromium.launch(headless=config["app"]["headless"])
    page = browser.new_page()
    page.goto(config["app"]["url"])

    execute(page, steps, resolve, llm)

    browser.close()

_____&__₹__

