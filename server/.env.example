# OpenAI API Key for AI-powered step interpretation
OPENAI_API_KEY=your_openai_api_key_here

# Jira Configuration (optional)
JIRA_BASE_URL=https://your-domain.atlassian.net
JIRA_EMAIL=your-email@example.com
JIRA_API_TOKEN=your_jira_api_token_here

# Server Configuration
PORT=3001
___&___


from browser_use import Agent
import asyncio
import base64
from typing import Callable, Optional
from ..config import settings
from ..auth import oauth_manager
from ..models import StepStatus

class BrowserAutomationService:
    def __init__(self):
        self.agent: Optional[Agent] = None
        self.browser_context = None
        self.page = None
        self.current_step = 0
        self.total_steps = 0
        self.is_running = False
    
    async def initialize_agent(self, task: str, steps: list):
        """Initialize browser agent with OAuth token"""
        try:
            # Get valid OAuth token
            access_token = await oauth_manager.get_access_token()
            
            # Configure agent with company API
            self.agent = Agent(
                task=task,
                browser_config={
                    'headless': settings.HEADLESS,
                },
                # Add your company's API configuration here
                llm_config={
                    'api_key': access_token,
                    'base_url': settings.API_BASE_URL,
                    # Add other model-specific configs
                }
            )
            
            self.total_steps = len(steps)
            self.current_step = 0
            self.is_running = True
            
            # Give browser time to initialize
            await asyncio.sleep(2)
            
            # Try to access browser through different possible attributes
            self.browser_context = await self._get_browser_context()
            if self.browser_context:
                self.page = await self._get_page()
            
            return True
            
        except Exception as e:
            print(f"❌ Agent initialization error: {e}")
            raise
    
    async def _get_browser_context(self):
        """Try different ways to access browser context"""
        try:
            # Try different possible attributes
            if hasattr(self.agent, 'browser'):
                return self.agent.browser
            elif hasattr(self.agent, 'browser_context'):
                return self.agent.browser_context
            elif hasattr(self.agent, '_browser'):
                return self.agent._browser
            elif hasattr(self.agent, 'playwright'):
                if hasattr(self.agent.playwright, 'browser'):
                    return self.agent.playwright.browser
            
            print("⚠️ Could not find browser context")
            return None
        except Exception as e:
            print(f"⚠️ Error accessing browser context: {e}")
            return None
    
    async def _get_page(self):
        """Try different ways to access page"""
        try:
            # Try different possible attributes
            if hasattr(self.browser_context, 'page'):
                return self.browser_context.page
            elif hasattr(self.browser_context, 'pages'):
                pages = self.browser_context.pages
                if pages:
                    return pages[0]
            elif hasattr(self.browser_context, 'new_page'):
                return await self.browser_context.new_page()
            
            # If browser_context is actually the page
            if hasattr(self.browser_context, 'screenshot'):
                return self.browser_context
            
            print("⚠️ Could not find page")
            return None
        except Exception as e:
            print(f"⚠️ Error accessing page: {e}")
            return None
    
    async def get_screenshot(self) -> Optional[str]:
        """Capture current browser screenshot as base64"""
        if not self.page:
            # Try to get page again
            if self.browser_context:
                self.page = await self._get_page()
            
            if not self.page:
                return None
        
        try:
            screenshot_bytes = await self.page.screenshot(
                type='jpeg',
                quality=settings.SCREENSHOT_QUALITY
            )
            
            screenshot_base64 = base64.b64encode(screenshot_bytes).decode('utf-8')
            return screenshot_base64
            
        except Exception as e:
            print(f"⚠️ Screenshot error: {e}")
            return None
    
    async def get_current_url(self) -> str:
        """Get current page URL"""
        if not self.page:
            return ""
        
        try:
            return self.page.url
        except:
            return ""
    
    async def run_automation(self, on_step_complete: Callable):
        """Run the automation task with step tracking"""
        try:
            # Run agent
            result = await self.agent.run()
            
            self.is_running = False
            return result
            
        except Exception as e:
            self.is_running = False
            print(f"❌ Automation error: {e}")
            raise
    
    def update_step(self, step_number: int):
        """Update current step number"""
        self.current_step = step_number
    
    async def cleanup(self):
        """Cleanup resources"""
        self.is_running = False
        
        try:
            if self.page:
                await self.page.close()
        except:
            pass
        
        try:
            if self.browser_context and hasattr(self.browser_context, 'close'):
                await self.browser_context.close()
        except:
            pass



