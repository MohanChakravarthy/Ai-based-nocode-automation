# OpenAI API Key for AI-powered step interpretation
OPENAI_API_KEY=your_openai_api_key_here

# Jira Configuration (optional)
JIRA_BASE_URL=https://your-domain.atlassian.net
JIRA_EMAIL=your-email@example.com
JIRA_API_TOKEN=your_jira_api_token_here

# Server Configuration
PORT=3001
___&___

from browser_use import Agent
import asyncio
import base64
from typing import Callable, Optional
from ..config import settings
from ..auth import oauth_manager
from ..models import StepStatus
from playwright.async_api import async_playwright, Browser, BrowserContext, Page

class BrowserAutomationService:
    def __init__(self):
        self.agent: Optional[Agent] = None
        self.playwright = None
        self.browser: Optional[Browser] = None
        self.context: Optional[BrowserContext] = None
        self.page: Optional[Page] = None
        self.current_step = 0
        self.total_steps = 0
        self.is_running = False
        self._monitoring = False
    
    async def initialize_agent(self, task: str, steps: list):
        """Initialize browser agent with OAuth token"""
        try:
            # Get valid OAuth token
            access_token = await oauth_manager.get_access_token()
            
            print("üîç Initializing agent...")
            
            # Start Playwright
            self.playwright = await async_playwright().start()
            
            # Launch browser manually so we have control
            self.browser = await self.playwright.chromium.launch(
                headless=settings.HEADLESS,
                args=['--no-sandbox', '--disable-setuid-sandbox']
            )
            
            # Create context
            self.context = await self.browser.new_context(
                viewport={'width': 1280, 'height': 720}
            )
            
            # Create page
            self.page = await self.context.new_page()
            
            print("‚úÖ Browser launched successfully")
            print(f"üìç Page created: {self.page.url}")
            
            # Now create the agent (it might create its own browser, but we have ours)
            self.agent = Agent(
                task=task,
                browser_config={
                    'headless': settings.HEADLESS,
                },
                llm_config={
                    'api_key': access_token,
                    'base_url': settings.API_BASE_URL,
                }
            )
            
            self.total_steps = len(steps)
            self.current_step = 0
            self.is_running = True
            
            print("‚úÖ Agent initialized")
            return True
            
        except Exception as e:
            print(f"‚ùå Agent initialization error: {e}")
            import traceback
            traceback.print_exc()
            raise
    
    async def get_screenshot(self) -> Optional[str]:
        """Capture current browser screenshot as base64"""
        if not self.page:
            print("‚ö†Ô∏è No page available")
            return None
        
        try:
            screenshot_bytes = await self.page.screenshot(
                type='jpeg',
                quality=settings.SCREENSHOT_QUALITY
            )
            
            screenshot_base64 = base64.b64encode(screenshot_bytes).decode('utf-8')
            return screenshot_base64
            
        except Exception as e:
            print(f"‚ö†Ô∏è Screenshot error: {e}")
            return None
    
    async def get_current_url(self) -> str:
        """Get current page URL"""
        if not self.page:
            return ""
        
        try:
            return self.page.url
        except Exception as e:
            return ""
    
    async def run_automation(self, on_step_complete: Callable):
        """Run the automation task"""
        try:
            print("üöÄ Starting automation...")
            
            # Start monitoring agent's browser
            asyncio.create_task(self._monitor_agent_browser())
            
            # Run the agent
            result = await self.agent.run()
            
            print(f"‚úÖ Automation completed: {result}")
            self.is_running = False
            self._monitoring = False
            return result
            
        except Exception as e:
            self.is_running = False
            self._monitoring = False
            print(f"‚ùå Automation error: {e}")
            import traceback
            traceback.print_exc()
            raise
    
    async def _monitor_agent_browser(self):
        """Monitor and sync with agent's browser if it creates one"""
        self._monitoring = True
        attempt = 0
        
        while self._monitoring and attempt < 30:
            attempt += 1
            await asyncio.sleep(1)
            
            try:
                # Try to find agent's page
                if hasattr(self.agent, 'controller'):
                    controller = self.agent.controller
                    print(f"üîç Found controller: {type(controller)}")
                    
                    if hasattr(controller, 'browser'):
                        browser = controller.browser
                        if hasattr(browser, 'contexts') and browser.contexts:
                            context = browser.contexts[0]
                            if context.pages:
                                agent_page = context.pages[0]
                                print(f"‚úÖ Found agent's page, syncing...")
                                self.page = agent_page
                                self._monitoring = False
                                return
                
                # Check other possible locations
                if hasattr(self.agent, 'browser_context'):
                    context = self.agent.browser_context
                    if hasattr(context, 'pages') and context.pages:
                        self.page = context.pages[0]
                        print(f"‚úÖ Found agent's page via browser_context")
                        self._monitoring = False
                        return
                        
            except Exception as e:
                if attempt % 5 == 0:
                    print(f"‚è≥ Monitoring agent browser... (attempt {attempt})")
    
    def update_step(self, step_number: int):
        """Update current step number"""
        self.current_step = step_number
    
    async def cleanup(self):
        """Cleanup resources"""
        print("üßπ Cleaning up...")
        self.is_running = False
        self._monitoring = False
        
        try:
            if self.page:
                await self.page.close()
                print("‚úÖ Page closed")
        except Exception as e:
            print(f"‚ö†Ô∏è Error closing page: {e}")
        
        try:
            if self.context:
                await self.context.close()
                print("‚úÖ Context closed")
        except Exception as e:
            print(f"‚ö†Ô∏è Error closing context: {e}")
        
        try:
            if self.browser:
                await self.browser.close()
                print("‚úÖ Browser closed")
        except Exception as e:
            print(f"‚ö†Ô∏è Error closing browser: {e}")
        
        try:
            if self.playwright:
                await self.playwright.stop()
                print("‚úÖ Playwright stopped")
        except Exception as e:
            print(f"‚ö†Ô∏è Error stopping playwright: {e}")

