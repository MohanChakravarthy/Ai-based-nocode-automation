# OpenAI API Key for AI-powered step interpretation
OPENAI_API_KEY=your_openai_api_key_here

# Jira Configuration (optional)
JIRA_BASE_URL=https://your-domain.atlassian.net
JIRA_EMAIL=your-email@example.com
JIRA_API_TOKEN=your_jira_api_token_here

# Server Configuration
PORT=3001

___&____

You are a senior browser automation engineer with 20+ years of real-world experience.

You specialize in:
- Playwright, Selenium, Puppeteer
- AI-driven browser automation (browser-use, LLM agents)
- Login automation, SSO, OAuth, CAPTCHA handling
- Secure credential handling (env vars, vaults, token reuse)
- Handling dynamic DOM, XPath/CSS breakage
- Proxy issues (407), headless vs non-headless debugging
- Performance, stability, and production-ready automation

Rules you MUST follow:
1. Always give practical, production-ready answers.
2. Prefer step-by-step explanations over theory.
3. If code is required:
   - Show minimal but complete working code
   - Explain WHY each step exists
4. Point out common mistakes and how to avoid them.
5. If multiple approaches exist:
   - Compare them
   - Recommend the BEST one for real projects
6. Assume the user is a developer working under time pressure.
7. Avoid generic AI answers. Think like a real engineer debugging a real issue.
8. Ask clarifying questions ONLY if absolutely required.

Your goal:
Help me build reliable, secure, and maintainable browser automation solutions efficiently.

_____&______

import os
import asyncio
from typing import Optional, List

from dotenv import load_dotenv

# -------------------------------------------------
# ENV must be loaded FIRST (telemetry, security)
# -------------------------------------------------
load_dotenv()

from browser_use import Agent, Browser
from browser_use.llm import ChatOpenAI

from oauth import get_oauth_token


class BrowserUseService:
    """
    Browser-use compliant backend service.
    Designed for secured, local, multi-user usage.
    """

    def __init__(self):
        # LLM config
        self.base_url = os.getenv("OPENAI_BASE_URL")
        self.model = os.getenv("OPENAI_MODEL", "gpt-4o-mini")

        # Browser config
        self.headless = os.getenv("BROWSER_HEADLESS", "true").lower() == "true"

        # Security
        self.allowed_domains = self._load_allowed_domains()

        # Concurrency control
        max_agents = int(os.getenv("MAX_CONCURRENT_AGENTS", "20"))
        self._semaphore = asyncio.Semaphore(max_agents)

        # Browser singleton
        self._browser: Optional[Browser] = None

    # -------------------------------------------------
    # Internal helpers
    # -------------------------------------------------
    def _load_allowed_domains(self) -> List[str]:
        raw = os.getenv("ALLOWED_DOMAINS", "")
        return [d.strip() for d in raw.split(",") if d.strip()]

    def _get_browser(self) -> Browser:
        if self._browser is None:
            # telemetry already disabled via ENV
            self._browser = Browser(headless=self.headless)
        return self._browser

    def _get_llm(self) -> ChatOpenAI:
        token = get_oauth_token()
        return ChatOpenAI(
            api_key=token,
            base_url=self.base_url,
            model=self.model,
        )

    # -------------------------------------------------
    # Public API
    # -------------------------------------------------
    async def run_task(self, task: str) -> dict:
        """
        Execute a browser-use task.
        Task must describe navigation explicitly.
        """

        async with self._semaphore:
            agent = Agent(
                task=task,
                llm=self._get_llm(),
                browser=self._get_browser(),
                allowed_domains=self.allowed_domains,
            )

            history = await agent.run()

            return {
                "status": "success",
                "history": history,
            }

    # -------------------------------------------------
    # Shutdown hook (FastAPI lifespan)
    # -------------------------------------------------
    async def shutdown(self):
        if self._browser:
            await self._browser.close()
            self._browser = None


import os
import asyncio
from typing import Dict, Optional, List

from dotenv import load_dotenv

# -------------------------------------------------
# ENV must be loaded FIRST (telemetry + security)
# -------------------------------------------------
load_dotenv()

from browser_use import Agent, Browser, BrowserProfile
from browser_use.llm import ChatAzureOpenAI


class BrowserUseService:
    """
    Secure, browser-use compliant service.
    Safe for parallel FastAPI usage.
    """

    def __init__(self):
        # -------------------------
        # Concurrency control
        # -------------------------
        max_agents = int(os.getenv("MAX_CONCURRENT_AGENTS", "20"))
        self._semaphore = asyncio.Semaphore(max_agents)

        # -------------------------
        # LLM (can be reused)
        # -------------------------
        self.llm = ChatAzureOpenAI(
            model="gpt-4.1-mini",
            api_key=os.getenv("AZURE_OPENAI_KEY"),
            azure_endpoint=os.getenv("AZURE_OPENAI_ENDPOINT"),
        )

        # -------------------------
        # Browser profile (IMMUTABLE)
        # -------------------------
        self.browser_profile = BrowserProfile(
            allowed_domains=self._load_allowed_domains(),
            enable_default_extensions=False,
        )

        # -------------------------
        # Browser (shared)
        # -------------------------
        self.browser = Browser(
            browser_profile=self.browser_profile,
            headless=os.getenv("BROWSER_HEADLESS", "true").lower() == "true",
        )

    # -------------------------------------------------
    # Helpers
    # -------------------------------------------------
    def _load_allowed_domains(self) -> List[str]:
        raw = os.getenv("ALLOWED_DOMAINS", "")
        return [d.strip() for d in raw.split(",") if d.strip()]

    # -------------------------------------------------
    # Public API (THIS IS THE BACKBONE)
    # -------------------------------------------------
    async def run_task(
        self,
        task: str,
        sensitive_data: Optional[Dict[str, str]] = None,
        max_steps: int = 10,
    ) -> Dict:
        """
        Run a secure browser-use task.
        - New Agent per request
        - Shared browser + profile
        - Safe for parallel users
        """

        async with self._semaphore:
            agent = Agent(
                task=task,
                llm=self.llm,
                browser=self.browser,
                browser_profile=self.browser_profile,
                sensitive_data=sensitive_data or {},
            )

            history = await agent.run(max_steps=max_steps)

            return {
                "status": "success",
                "history": history,
            }

    # -------------------------------------------------
    # Shutdown hook (FastAPI lifespan later)
    # -------------------------------------------------
    async def shutdown(self):
        await self.browser.close()


import asyncio
from browser_use_service import BrowserUseService

service = BrowserUseService()

async def test():
    result = await service.run_task(
        task="Find the founders of {{company_name}}",
        sensitive_data={"company_name": "browser-use"},
        max_steps=10,
    )
    print(result)

asyncio.run(test())



<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ABC TeamMate Premium Login - Final Edit</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#3b82f6",
                        "primary-dark": "#2563eb",
                        "accent": "#8b5cf6",
                        "slate-deep": "#1e293b",
                        "slate-light": "#f8fafc",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    animation: {
                        'wave': 'wave 15s ease-in-out infinite',
                        'wave-slow': 'wave 20s ease-in-out infinite reverse',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        wave: {
                            '0%, 100%': { transform: 'translate(0, 0) rotate(0deg)' },
                            '25%': { transform: 'translate(10%, 10%) rotate(5deg)' },
                            '50%': { transform: 'translate(0, 20%) rotate(0deg)' },
                            '75%': { transform: 'translate(-10%, 10%) rotate(-5deg)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                },
            },
        }
    </script>
<style type="text/tailwindcss">
        @layer utilities {
            .glass-input {
                @apply bg-slate-50 border border-slate-200 text-slate-800 placeholder:text-slate-400 focus:border-primary focus:bg-white focus:ring-4 focus:ring-primary/10 transition-all duration-300;
            }
            .primary-btn {
                @apply bg-[#3b82f6] hover:bg-[#2563eb] shadow-lg shadow-blue-500/30 text-white transition-all active:scale-[0.98] rounded-full;
            }
            .secondary-btn {
                @apply bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:border-slate-300 transition-all active:scale-[0.98] rounded-full;
            }
            .glass-card-bottom {
                @apply bg-white/10 backdrop-blur-md border border-white/20 shadow-[0_8px_32px_rgba(0,0,0,0.1)];
            }
            ::-webkit-scrollbar {
                width: 0px;
                background: transparent;
            }
        }
        body {
            font-family: 'Manrope', sans-serif;
            background-color: #ffffff;
        }
        .liquid-gradient {
            background: radial-gradient(circle at 50% 50%, #1e40af 0%, #000000 100%);
            position: relative;
            overflow: hidden;
        }
        .liquid-shape {
            position: absolute;
            filter: blur(60px);
            opacity: 0.8;
        }
        .shape-1 {
            top: -20%;
            left: -20%;
            width: 80%;
            height: 80%;
            background: #3b82f6;
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            animation: wave 15s infinite linear;
        }
        .shape-2 {
            bottom: -20%;
            right: -20%;
            width: 80%;
            height: 80%;
            background: #60a5fa;
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            animation: wave-slow 18s infinite linear;
        }
        .shape-3 {
            top: 40%;
            left: 40%;
            width: 60%;
            height: 60%;
            background: #2563eb;
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            animation: wave 12s infinite linear reverse;
            mix-blend-mode: overlay;
        }
        .toggle-container {
            background-color: #f1f5f9;
            border-radius: 9999px;
            padding: 4px;
            display: inline-flex;
            position: relative;
        }
        .toggle-btn {
            border-radius: 9999px;
            padding: 8px 32px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
        }
        .toggle-btn.active {
            color: #ffffff;
        }
        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            height: calc(100% - 8px);
            width: calc(50% - 4px);
            background-color: #3b82f6;
            border-radius: 9999px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 1;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
    </style>
</head>
<body class="text-slate-600 min-h-screen flex w-full overflow-hidden">
<div class="hidden lg:flex w-1/2 liquid-gradient relative flex-col items-center justify-between p-12 overflow-hidden">
<div class="liquid-shape shape-1"></div>
<div class="liquid-shape shape-2"></div>
<div class="liquid-shape shape-3"></div>
<div class="w-full relative z-30 flex justify-start">
<div class="flex items-center gap-3">
<div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-500/20 border border-white/10">
<span class="material-symbols-outlined text-white text-xl">smart_toy</span>
</div>
<span class="text-xl font-bold text-white tracking-tight font-display">ABC TeamMate</span>
</div>
</div>
<div class="flex-1 w-full flex flex-col items-center justify-center relative z-20">
<div class="relative w-full max-w-lg">
<div class="relative w-full perspective-1000 scale-[0.85] origin-center">
<div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-blue-500/30 blur-[100px] rounded-full"></div>
<div class="glass-panel rounded-2xl shadow-[0_35px_60px_-15px_rgba(0,0,0,0.5)] overflow-hidden transform transition-transform hover:scale-[1.02] duration-500">
<div class="h-12 bg-white/5 border-b border-white/10 flex items-center px-4 gap-3">
<div class="flex gap-2">
<div class="w-3 h-3 rounded-full bg-[#FF5F56] shadow-inner"></div>
<div class="w-3 h-3 rounded-full bg-[#FFBD2E] shadow-inner"></div>
<div class="w-3 h-3 rounded-full bg-[#27C93F] shadow-inner"></div>
</div>
<div class="bg-black/20 rounded-md px-3 py-1 flex-1 max-w-xs mx-auto flex items-center gap-2 border border-white/5">
<span class="material-symbols-outlined text-[10px] text-white/40">lock</span>
<div class="text-[10px] text-white/40 font-mono">abc-teammate.ai/dashboard</div>
</div>
</div>
<div class="p-8">
<div class="flex justify-between items-start mb-8">
<div>
<h3 class="text-white font-bold text-lg tracking-tight mb-1">Automation Sequence</h3>
<p class="text-blue-200/60 text-xs">Task ID: #8842-Alpha</p>
</div>
<div class="px-3 py-1.5 rounded-full bg-emerald-500/20 border border-emerald-500/30 text-emerald-300 text-[10px] font-bold uppercase tracking-wider flex items-center gap-2 shadow-[0_0_15px_rgba(16,185,129,0.3)]">
<span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
                                AI Engine Active
                            </div>
</div>
<div class="space-y-5">
<div class="group">
<div class="flex justify-between items-center text-xs text-white/80 mb-2 font-medium">
<span class="flex items-center gap-2">
<span class="w-5 h-5 rounded bg-blue-500/20 flex items-center justify-center text-[10px] border border-blue-500/30">01</span>
                                        Data Extraction
                                    </span>
<span class="text-blue-300">Complete</span>
</div>
<div class="h-2 w-full bg-white/5 rounded-full overflow-hidden">
<div class="h-full w-full bg-gradient-to-r from-blue-600 to-blue-400 rounded-full"></div>
</div>
</div>
<div class="group">
<div class="flex justify-between items-center text-xs text-white/80 mb-2 font-medium">
<span class="flex items-center gap-2">
<span class="w-5 h-5 rounded bg-purple-500/20 flex items-center justify-center text-[10px] border border-purple-500/30">02</span>
                                        Pattern Analysis
                                    </span>
<span class="text-purple-300 animate-pulse-slow">Processing...</span>
</div>
<div class="h-2 w-full bg-white/5 rounded-full overflow-hidden">
<div class="h-full w-[75%] bg-gradient-to-r from-purple-600 to-purple-400 rounded-full shadow-[0_0_10px_rgba(168,85,247,0.5)] animate-pulse"></div>
</div>
</div>
<div class="group opacity-60">
<div class="flex justify-between items-center text-xs text-white/80 mb-2 font-medium">
<span class="flex items-center gap-2">
<span class="w-5 h-5 rounded bg-white/10 flex items-center justify-center text-[10px] border border-white/20">03</span>
                                        Report Generation
                                    </span>
<span>Pending</span>
</div>
<div class="h-2 w-full bg-white/5 rounded-full overflow-hidden">
<div class="h-full w-0 bg-white/20 rounded-full"></div>
</div>
</div>
</div>
<div class="mt-8 grid grid-cols-3 gap-3">
<div class="h-16 rounded-lg bg-white/5 border border-white/10 flex items-end justify-center p-2 gap-1 overflow-hidden relative">
<div class="w-2 bg-blue-500/50 rounded-t h-[40%]"></div>
<div class="w-2 bg-blue-500/70 rounded-t h-[70%]"></div>
<div class="w-2 bg-blue-400 rounded-t h-[50%]"></div>
</div>
<div class="h-16 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center relative overflow-hidden">
<div class="absolute inset-0 bg-gradient-to-tr from-purple-500/20 to-transparent"></div>
<span class="material-symbols-outlined text-purple-300/80 text-2xl">donut_small</span>
</div>
<div class="h-16 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center relative overflow-hidden">
<span class="material-symbols-outlined text-blue-300/80 text-2xl">hub</span>
</div>
</div>
</div>
</div>
</div>
<div class="absolute -right-8 -top-6 glass-panel p-3 rounded-xl shadow-xl flex items-center gap-3 animate-float" style="animation-delay: 0s;">
<div class="bg-gradient-to-br from-green-500/20 to-green-500/10 p-2 rounded-lg border border-green-500/20">
<span class="material-symbols-outlined text-green-400 text-lg">check_circle</span>
</div>
<div>
<div class="text-[9px] text-white/50 uppercase tracking-widest font-bold">Status</div>
<div class="text-xs font-bold text-white tracking-wide">Automated</div>
</div>
</div>
<div class="absolute -left-10 bottom-12 glass-panel p-3 rounded-xl shadow-xl flex items-center gap-3 animate-float" style="animation-delay: 1.5s;">
<div class="bg-gradient-to-br from-blue-500/20 to-blue-500/10 p-2 rounded-lg border border-blue-500/20">
<span class="material-symbols-outlined text-blue-400 text-lg">auto_mode</span>
</div>
<div>
<div class="text-[9px] text-white/50 uppercase tracking-widest font-bold">AI Model</div>
<div class="text-xs font-bold text-white tracking-wide">analysing web app</div>
</div>
</div>
</div>
<div class="mt-12 text-center relative z-30 max-w-xl mx-auto">
<h1 class="text-4xl xl:text-5xl font-extrabold text-white tracking-tight font-display mb-3 leading-[1.1]">
                A <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-blue-500">Digital TeamMate</span>
</h1>
<p class="text-xl xl:text-2xl text-blue-100/80 font-medium font-display tracking-tight">
                Scale your operations with <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-blue-500">Precision</span>
</p>
</div>
</div>
<div class="text-center relative z-10 mt-8">
<div class="text-[10px] text-white/40 font-medium tracking-wide">
            © 2024 ABC TeamMate. All rights reserved.
        </div>
</div>
</div>
<div class="w-full lg:w-1/2 bg-white flex flex-col h-screen relative z-10 overflow-y-auto">
<div class="flex-1 flex flex-col justify-center items-center px-8 sm:px-12 lg:px-20 py-12">
<div class="w-full max-w-[420px]">
<div class="flex items-center gap-3 mb-10">
<div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-500/20">
<span class="material-symbols-outlined text-white text-2xl">smart_toy</span>
</div>
<h1 class="text-2xl font-bold text-slate-900 tracking-tight">ABC TeamMate</h1>
</div>
<div class="mb-8">
<h2 class="text-3xl font-bold text-slate-900 mb-3">Welcome Back!</h2>
<p class="text-slate-500">Access your automation dashboard.</p>
</div>
<div class="flex justify-start mb-8">
<div class="toggle-container w-full">
<div class="toggle-btn active w-1/2 text-center" onclick="document.querySelector('.toggle-slider').style.transform = 'translateX(0)'; this.classList.add('active'); this.nextElementSibling.classList.remove('active');">Sign In</div>
<div class="toggle-btn w-1/2 text-center" onclick="document.querySelector('.toggle-slider').style.transform = 'translateX(100%)'; this.classList.add('active'); this.previousElementSibling.classList.remove('active');">Sign Up</div>
<div class="toggle-slider w-[calc(50%-4px)]"></div>
</div>
</div>
<form class="space-y-6">
<div class="relative group">
<label class="block text-xs font-semibold text-slate-600 mb-2 ml-1">Email Address</label>
<input class="glass-input w-full rounded-xl py-3.5 px-5 text-sm outline-none" placeholder="name@company.com" type="email"/>
<span class="material-symbols-outlined absolute right-5 top-[42px] text-slate-400 text-xl pointer-events-none">mail</span>
</div>
<div class="relative group">
<label class="block text-xs font-semibold text-slate-600 mb-2 ml-1">Password</label>
<input class="glass-input w-full rounded-xl py-3.5 px-5 text-sm outline-none" placeholder="••••••••" type="password"/>
<button class="absolute right-5 top-[42px] text-slate-400 hover:text-slate-600 transition-colors focus:outline-none" type="button">
<span class="material-symbols-outlined text-xl">visibility</span>
</button>
</div>
<div class="flex items-center justify-between">
<label class="flex items-center cursor-pointer">
<input class="form-checkbox h-4 w-4 text-blue-600 rounded border-slate-300 focus:ring-blue-500 transition duration-150 ease-in-out" type="checkbox"/>
<span class="ml-2 text-sm text-slate-500">Remember me</span>
</label>
<a class="text-sm font-semibold text-blue-600 hover:text-blue-700" href="#">Forgot Password?</a>
</div>
<button class="w-full primary-btn font-semibold py-4 text-sm tracking-wide shadow-blue-500/25 shadow-lg rounded-xl" type="submit">
                    Access Dashboard
                </button>
</form>
<div class="relative my-8">
<div class="absolute inset-0 flex items-center">
<div class="w-full border-t border-slate-200"></div>
</div>
<div class="relative flex justify-center text-xs uppercase text-slate-400">
<span class="bg-white px-3 font-medium tracking-wider">Or continue with</span>
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<button class="w-full secondary-btn py-3 rounded-xl flex items-center justify-center gap-3 group text-slate-700 font-medium text-sm hover:border-blue-200 hover:text-blue-600 hover:bg-blue-50/50">
<span class="material-symbols-outlined text-xl">fingerprint</span>
                    SSO
                </button>
<button class="w-full secondary-btn py-3 rounded-xl flex items-center justify-center gap-3 group text-slate-700 font-medium text-sm hover:border-blue-200 hover:text-blue-600 hover:bg-blue-50/50">
<img alt="Google" class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity" src="https://lh3.googleusercontent.com/aida-public/AB6AXuBk_WnSN6e8OmtPT66SJUbAudEJTjcZw8c5O-AK9szdJLNlAJ51Xqdhd08XREAGORAf4YuTCSM0hFWA84yqVDGVRofYezQYSTfAkh2UwpeOHYRKOo9QJ5DOQEV5PayRiwF5soyuNtxCaE3g1THxyXHb7DWxMiSzi9nv6eGFlMrryleOSPD1kLSmS3s2xDUBCHMOBmIu4cQi4aeWmAz4kNyXDPN_OMYkALPhnOEtUXHdHavDlHzmi-uJicst0yg4vjGwGvHQ9RuQm0Kl"/>
                    Google
                </button>
</div>
</div>
</div>
</div>

</body></html>
